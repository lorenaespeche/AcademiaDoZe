<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
            xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
            x:Class="AcademiaDoZe.Presentation.AppMaui.Views.MatriculaPage"
            xmlns:vm="clr-namespace:AcademiaDoZe.Presentation.AppMaui.ViewModels"
            xmlns:enums="clr-namespace:AcademiaDoZe.Application.Enums;assembly=AcademiaDoZe.Application"
            xmlns:converters="clr-namespace:AcademiaDoZe.Presentation.AppMaui.Converters"
            xmlns:dto="clr-namespace:AcademiaDoZe.Application.DTOs;assembly=AcademiaDoZe.Application"
            x:DataType="vm:MatriculaViewModel"
        Title="{Binding Title}">
    <ContentPage.Resources>
        <converters:FotoToImageSourceConverter x:Key="FotoToImageSourceConverter" />
        <converters:DateOnlyToDateTimeConverter x:Key="DateOnlyConverter" />
        <converters:EnumDisplayConverter x:Key="EnumDisplay" />
    </ContentPage.Resources>
    <ScrollView>
        <StackLayout Spacing="20">
            <!-- CPF Section -->

            <Border Style="{StaticResource CardBorder}" Margin="15,10">

                <StackLayout Spacing="5">
                    <Label Text="CPF"/>
                    <Grid ColumnDefinitions="*,Auto">
                        <Entry Grid.Column="0" Text="{Binding Matricula.AlunoMatricula.Cpf}" Placeholder="000.000.000-00" Keyboard="Numeric" Margin="0,0,10,0"/>
                        <Button Grid.Column="1" Text="" Command="{Binding SearchByCpfCommand}" Style="{StaticResource ButtonPrimary}" HeightRequest="40" Padding="15,0">
                            <Button.ImageSource>
                                <FontImageSource FontFamily="MaterialIcons" Glyph="&#xe8b6;" />
                            </Button.ImageSource>
                        </Button>
                    </Grid>
                </StackLayout>
            </Border>
            <!-- Dados Pessoais -->

            <Border Style="{StaticResource CardBorder}" Margin="15,10">

                <StackLayout Spacing="15">
                    <StackLayout Orientation="Horizontal">
                        <Label Text="Aluno Selecionado:"/>
                        <Label Text="{Binding Matricula.AlunoMatricula.Nome}" Margin="5,0,0,0" />
                    </StackLayout>
                    <StackLayout>
                        <Label Text="{Binding Matricula.Id, StringFormat='Matricula ID: {0}'}" Style="{StaticResource SubHeadline}"/>
                        <Picker ItemsSource="{Binding MatriculaPlanos}" SelectedItem="{Binding Matricula.Plano}">
                            <Picker.ItemDisplayBinding>
                                <Binding Converter="{StaticResource EnumDisplay}" />
                            </Picker.ItemDisplayBinding>
                        </Picker>
                    </StackLayout>
                    <StackLayout Spacing="20" Orientation="Horizontal">
                        <Label Text="Data Inicio/Fim"/>
                        <DatePicker Date="{Binding Matricula.DataInicio, Converter={StaticResource DateOnlyConverter}, Mode=TwoWay}"/>
                        <DatePicker Date="{Binding Matricula.DataFim, Converter={StaticResource DateOnlyConverter}, Mode=TwoWay}"/>
                    </StackLayout>
                    <StackLayout Spacing="5">
                        <Label Text="Objetivo"/>
                        <Entry Text="{Binding Matricula.Objetivo}" Placeholder="Digite seu objetivo" />
                    </StackLayout>
                    <VerticalStackLayout Padding="20">
                        <Label Text="Selecione as restrições médicas:" 
                                Style="{StaticResource SubHeadline}" />

                        <!--Lista de CheckBoxes-->
                        <CollectionView ItemsSource="{Binding OpcoesTipo}">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="vm:TipoMatriculaOption">
                                    <Grid ColumnDefinitions="*, Auto" Padding="10,5">
                                        <Label Grid.Column="0" 
                                            Text="{Binding Nome}" 
                                            VerticalOptions="Center" />

                                        <CheckBox Grid.Column="1" 
                                        IsChecked="{Binding IsSelecionado, Mode=TwoWay}"
                                        VerticalOptions="Center"/>
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                    <StackLayout Spacing="5">
                        <Label Text="Observações restrições"/>
                        <Entry Text="{Binding Matricula.ObservacoesRestricoes}" Placeholder="Digite as observações das restrições" />
                    </StackLayout>
                    <StackLayout Spacing="5">
                        <Label Text="Foto"/>
                        <Image Source="{Binding Matricula.LaudoMedico, Converter={StaticResource FotoToImageSourceConverter}}" Aspect="AspectFill" HeightRequest="120" WidthRequest="120"/>
                        <Button Text="Selecionar Imagem" Command="{Binding SelecionarFotoCommand}" Style="{StaticResource ButtonPrimary}" >
                            <Button.ImageSource>
                                <FontImageSource FontFamily="MaterialIcons" Glyph="&#xe226;" />
                            </Button.ImageSource>
                        </Button>
                    </StackLayout>
                </StackLayout>
            </Border>

            <Grid ColumnDefinitions="*,*" ColumnSpacing="10" Margin="15,10">

                <Button Grid.Column="0" Text="Cancelar" Command="{Binding CancelCommand}" Style="{StaticResource ButtonSecondary}" HeightRequest="50">
                    <Button.ImageSource>
                        <FontImageSource FontFamily="MaterialIcons" Glyph="&#xe5c9;" />
                    </Button.ImageSource>
                </Button>

                <Button Grid.Column="1" Text="Salvar" Command="{Binding SaveMatriculaCommand}" Style="{StaticResource ButtonPrimary}" HeightRequest="50">

                    <Button.ImageSource>
                        <FontImageSource FontFamily="MaterialIcons" Glyph="&#xf233;" />
                    </Button.ImageSource>
                </Button>
            </Grid>
            <!-- Loading Indicator -->
            <ActivityIndicator IsVisible="{Binding IsBusy}" IsRunning="{Binding IsBusy}" VerticalOptions="Center" HorizontalOptions="Center"/>

        </StackLayout>
    </ScrollView>
</ContentPage>